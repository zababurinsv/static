import mInterface from"./interface.mjs";import classicedition from"./classicedition.mjs";import gameplay from"./gameplay.mjs";import auction from"./auction.mjs";let trade=[];trade.staticProperty=[],trade.staticProperty.initiator=[],trade.staticProperty.recipient=[],trade.staticProperty.property=new Array(40),trade.staticProperty.money=[],trade.staticProperty.communityChestJailCard=[],trade.staticProperty.chanceJailCard=[];export default{get:(e,t,...r)=>new Promise((r,a)=>{function n(e){r(e)}switch(e.type){case"eliminatePlayer":(async(e,t,r)=>{let a=t.player[t.turn];for(let e=a.index;e<t.pcount;e++)t.player[e]=t.player[e+1],t.player[e].index=e;for(var i=0;i<40;i++)t.square[i].owner>=a.index&&t.square[i].owner--;t.pcount--,t.turn--,2===t.pcount?t.this.getElementById("stats").style.width="44.336vw":3===t.pcount&&(t.this.getElementById("stats").style.width="66.992vw"),1===t.pcount?(await mInterface.get({type:"updateMoney"},t),$("#control").hide(),$("#board").hide(),$("#refresh").show(),await mInterface.get({type:"popup",HTML:"<p>Congratulations, "+t.player[1].name+", you have won the game.</p><div>"},t)):await mInterface.get({type:"play"},t),n(t)})(0,t);break;case"play":(async(e,t,r)=>{if(await mInterface.get({type:"auction"},t))n(t);else{console.assert(!1,t),t.turn++,t.turn>t.pcount&&(t.turn-=t.pcount);let r=t.player[t.turn];await mInterface.get({type:"resetDice"},t),t.this.getElementById("pname").innerHTML=r.name,await mInterface.get({type:"addAlert",value:"It is "+r.name+"'s turn."},t),r.pay(0,r.creditor,t),t.this.querySelector("#landed").style.display="none",t.this.querySelector("#option").style.display="none",t.this.querySelector("#manage").style.display="none",t.this.querySelector("#board").style.display="flex",t.this.querySelector("#control").style.display="flex",t.this.querySelector("#moneybar").style.display="flex",t.this.querySelector("#buy").style.display="flex",t.doublecount=0,r.human&&t.this.getElementById("nextbutton").focus(),t.this.getElementById("nextbutton").value="Roll Dice",t.this.getElementById("nextbutton").title="Roll the dice and move your token accordingly.",t.this.querySelector("#die0").style.display="none",t.this.querySelector("#die1").style.display="none",r.jail&&(t.this.querySelector("#landed").style.display="flex",t.this.getElementById("landed").innerHTML="You are in jail.<input id='landedItemjail' type='button' title='Pay $50 fine to get out of jail immediately.' value='Pay $50 fine' />",t.this.querySelector("#landedItemjail").addEventListener("click",async()=>{console.assert(!1),await mInterface.get({type:"payFifty"},t)}),(r.communityChestJailCard||r.chanceJailCard)&&(t.this.getElementById("landed").innerHTML+="<input type='button' id='gojfbutton' title='Use &quot;Get Out of Jail Free&quot; card.' value='Use Card' />",t.this.querySelector("#gojfbutton").addEventListener("click",async()=>{await mInterface.get({type:"useJailCard"},t)})),t.this.getElementById("nextbutton").title="Roll the dice. If you throw doubles, you will get out of jail.",0===r.jailroll?await mInterface.get({type:"addAlert",value:"This is "+r.name+"'s first turn in jail."},t):1===r.jailroll?await mInterface.get({type:"addAlert",value:"This is "+r.name+"'s second turn in jail."},t):2===r.jailroll&&(t.this.getElementById("landed").innerHTML+="<div>NOTE: If you do not throw doubles after this roll, you <i>must</i> pay the $50 fine.</div>",await mInterface.get({type:"addAlert",value:"This is "+r.name+"'s third turn in jail."},t)),!r.human&&r.AI.postBail()&&(r.communityChestJailCard||r.chanceJailCard?await mInterface.get({type:"useJailCard"},t):await mInterface.get({type:"payfifty"},t))),await mInterface.get({type:"updateMoney"},t),await mInterface.get({type:"updatePosition"},t),await mInterface.get({type:"updateOwned"},t);let a=t.this.querySelectorAll(".money-bar-arrow");for(let e=0;e<a.length;e++)a[e].style.display="none";t.this.querySelector(`#p${t.turn}arrow`).style.display="flex",r.human||r.AI.beforeTurn()||await mInterface.get({type:"next",player:r},e)}})(e,t);break;case"bankruptcy":(async(e,t,r)=>{let a=t.player[t.turn],i=t.player[a.creditor];t.bankruptcyUnmortgageFee=0,a.money>=0&&n(t),await mInterface.get({type:"addAlert",value:a.name+" is bankrupt."},t),0!==a.creditor&&(i.money+=a.money);for(let e=0;e<40;e++){let r=t.square[e];r.owner==a.index&&(r.mortgage?t.bankruptcyUnmortgageFee+=Math.round(.1*r.price):r.owner=a.creditor,r.house>0&&(0!==a.creditor&&(i.money+=.5*r.houseprice*r.house),r.hotel=0,r.house=0),0===a.creditor&&(r.mortgage=!1,t.auctionQueue.push(e),r.owner=0))}await gameplay.get({type:"updateMoney"},t),a.chanceJailCard&&(a.chanceJailCard=!1,i.chanceJailCard=!0),a.communityChestJailCard&&(a.communityChestJailCard=!1,i.communityChestJailCard=!0),2===t.pcount||0===t.bankruptcyUnmortgageFee||0===a.creditor?await mInterface.get({type:"eliminatePlayer"},t):(await mInterface.get({type:"addAlert",value:i.name+" paid $"+t.bankruptcyUnmortgageFee+" interest on the mortgaged properties received from "+a.name+"."},t),await mInterface.get({type:"popup",HTML:"<p>"+i.name+", you must pay $"+t.bankruptcyUnmortgageFee+" interest on the mortgaged properties you received from "+a.name+".</p>",action:async function(){await t.player[i.index].pay(t.bankruptcyUnmortgageFee,0,t),await mInterface.get({type:"bankruptcyUnmortgage"},t)}}))})(0,t);break;case"chanceCommunityChest":(async(e,t,r)=>{console.assert(!1,t);let a=t.player[t.turn];if(2===a.position||17===a.position||33===a.position){let e=t.communityChestCards.deck[t.communityChestCards.index];0===e&&t.communityChestCards.deck.splice(t.communityChestCards.index,1),await mInterface.get({type:"popup",HTML:`\n                            <img src='./static/html/components/main-manager/images/community_chest_icon.png' style='height: 15vw; width: 15vw;  margin: 0.781vw 0.781vw 0.781vw 0;' />\n                            <div class="containerCard">\n                            <div style='font-weight: bold; font-size: 3vw; '>Community Chest:</div>\n                            <div style='text-align: center;'>${t.communityChestCards[e].text}</div>\n                            </div>\n                            `,action:async function(t,r){await auction.get({type:"communityChestAction",communityChestIndex:e},r)}},t),t.communityChestCards.index++,t.communityChestCards.index>=t.communityChestCards.deck.length&&(t.communityChestCards.index=0)}else if(7===a.position||22===a.position||36===a.position){let e=t.chanceCards.deck[t.chanceCards.index];0===e&&t.chanceCards.deck.splice(t.chanceCards.index,1),await mInterface.get({type:"popup",HTML:"<img src='./static/html/components/main-manager/images/chance_icon.png' style='height: 7.883vw; width: 5vw; float: left; margin: 0.781vw 0.781vw 0.781vw 0;' /><div style='font-weight: bold; font-size: 3vw; '>Chance:</div><div style='text-align: justify;'>"+t.chanceCards[e].text+"</div>",action:async function(t,r){await auction.get({type:"chanceAction",chanceIndex:e},r)}},t),t.chanceCards.index++,t.chanceCards.index>=t.chanceCards.deck.length&&(t.chanceCards.index=0)}else a.human||(a.AI.alertList="",a.AI.onLand()||game.next())})(0,t);break;case"sellHouse":(async(e,t,r)=>{let a=t.square[e.index],n=t.player[a.owner];1===a.hotel?(a.hotel=0,a.house=4,await mInterface.get({type:"addAlert",value:n.name+" sold the hotel on "+a.name+"."},t)):(a.house--,await mInterface.get({type:"addAlert",value:n.name+" sold a house on "+a.name+"."},t)),n.money+=.5*a.houseprice,await gameplay.get({type:"updateOwned",value:""},t),await gameplay.get({type:"updateMoney"},t)})(e,t);break;case"buyHouse":(async(e,t,r)=>{let a=t.square[e.index],i=t.player[a.owner],o=0,l=0;if(i.money-a.houseprice<0)a.house,n(!1);else{for(let e=0;e<40;e++)1===t.square[e].hotel?l++:o+=t.square[e].house;if(a.house<4){if(o>=32)return!1;a.house++,await mInterface.get({type:"addAlert",value:i.name+" placed a house on "+a.name+"."},t)}else{if(l>=12)return;a.house=5,a.hotel=1,await mInterface.get({type:"addAlert",value:i.name+" placed a hotel on "+a.name+"."},t)}i.pay(a.houseprice,0,t),await gameplay.get({type:"updateOwned",value:""},t),await gameplay.get({type:"updateMoney"},t)}})(e,t);break;case"resetTrade":(async(e,t,r)=>{let a,i,o,l,d,s,c,p;t.currentSquare={},t.currentTableRow={},t.currentTableCell={},t.currentTableCellCheckbox={},t.nameSelect={},t.currentOption={},t.allGroupUninproved={},t.currentName={};let y=function(e){t.this.querySelector("#proposetradebutton").style.display="flex",t.this.querySelector("#canceltradebutton").style.display="flex",t.this.querySelector("#accepttradebutton").style.display="none",t.this.querySelector("#rejecttradebutton").style.display="none"},u=function(e){let r=e.target.parentNode;r=r.querySelector("input"),t.checkboxElement=r,t.checkboxElement!==e.srcElement&&(t.checkboxElement.checked=!t.checkboxElement.checked),t.this.querySelector("#proposetradebutton").style.display="flex",t.this.querySelector("#canceltradebutton").style.display="flex",t.this.querySelector("#accepttradebutton").style.display="none",t.this.querySelector("#rejecttradebutton").style.display="none"},m=t.this.getElementById("trade-leftp-property"),h=t.this.getElementById("trade-rightp-property");for(t.tradeObj.currentInitiator=t.tradeObj.initiator,t.tradeObj.currentRecipient=t.tradeObj.recipient;m.lastChild;)m.removeChild(m.lastChild);for(;h.lastChild;)h.removeChild(h.lastChild);let g=document.createElement("table"),b=document.createElement("table");for(let r=0;r<40;r++){if((a=t.square[r]).house>0||0===a.groupNumber)continue;c=!0;let n=a.group.length;for(let e=0;e<n;e++)if(t.square[a.group[e]].house>0){c=!1;break}c&&(a.owner===e.initiator.index?((i=g.appendChild(document.createElement("tr"))).addEventListener("click",u),(o=i.appendChild(document.createElement("td"))).className="propertycellcheckbox",(l=o.appendChild(document.createElement("input"))).type="checkbox",l.id="tradeleftcheckbox"+r,l.title="Check this box to include "+a.name+" in the trade.",(o=i.appendChild(document.createElement("td"))).className="propertycellcolor",o.setAttribute("show",r),o.style.backgroundColor=a.color,1==a.groupNumber||2==a.groupNumber?o.style.borderColor="grey":o.style.borderColor=a.color,o.propertyIndex=r,o.onmouseover=async function(e){await mInterface.get({type:"showdeed",property:e.target.getAttribute("show")},t)},o.onmouseout=function(e){t.this.querySelector("#deed").style.display="none"},(o=i.appendChild(document.createElement("td"))).className="propertycellname",a.mortgage&&(o.title="Mortgaged",o.style.color="grey"),o.textContent=a.name):a.owner===t.tradeObj.recipient.index&&((i=b.appendChild(document.createElement("tr"))).addEventListener("click",u),(o=i.appendChild(document.createElement("td"))).className="propertycellcheckbox",(l=o.appendChild(document.createElement("input"))).type="checkbox",l.id="traderightcheckbox"+r,l.title="Check this box to include "+a.name+" in the trade.",(o=i.appendChild(document.createElement("td"))).className="propertycellcolor",o.setAttribute("show",r),o.style.backgroundColor=a.color,1==a.groupNumber||2==a.groupNumber?o.style.borderColor="grey":o.style.borderColor=a.color,o.propertyIndex=r,o.onmouseover=async function(e){await mInterface.get({type:"showdeed",property:e.target.getAttribute("show")},t)},o.onmouseout=function(){t.this.querySelector("#deed").style.display="none"},(o=i.appendChild(document.createElement("td"))).className="propertycellname",a.mortgage&&(o.title="Mortgaged",o.style.color="grey"),o.textContent=a.name))}if(t.tradeObj.initiator.communityChestJailCard?((i=g.appendChild(document.createElement("tr"))).addEventListener("click",u),(o=i.appendChild(document.createElement("td"))).className="propertycellcheckbox",(l=o.appendChild(document.createElement("input"))).type="checkbox",l.id="tradeleftcheckbox40",l.title="Check this box to include this Get Out of Jail Free Card in the trade.",(o=i.appendChild(document.createElement("td"))).className="propertycellcolor",o.style.backgroundColor="white",o.style.borderColor="grey",(o=i.appendChild(document.createElement("td"))).className="propertycellname",o.textContent="Get Out of Jail Free Card"):t.tradeObj.recipient.communityChestJailCard&&((i=b.appendChild(document.createElement("tr"))).addEventListener("click",u),(o=i.appendChild(document.createElement("td"))).className="propertycellcheckbox",(l=o.appendChild(document.createElement("input"))).type="checkbox",l.id="traderightcheckbox40",l.title="Check this box to include this Get Out of Jail Free Card in the trade.",(o=i.appendChild(document.createElement("td"))).className="propertycellcolor",o.style.backgroundColor="white",o.style.borderColor="grey",(o=i.appendChild(document.createElement("td"))).className="propertycellname",o.textContent="Get Out of Jail Free Card"),t.tradeObj.initiator.chanceJailCard?((i=g.appendChild(document.createElement("tr"))).addEventListener("click",u),(o=i.appendChild(document.createElement("td"))).className="propertycellcheckbox",(l=o.appendChild(document.createElement("input"))).type="checkbox",l.id="tradeleftcheckbox41",l.title="Check this box to include this Get Out of Jail Free Card in the trade.",(o=i.appendChild(document.createElement("td"))).className="propertycellcolor",o.style.backgroundColor="white",o.style.borderColor="grey",(o=i.appendChild(document.createElement("td"))).className="propertycellname",o.textContent="Get Out of Jail Free Card"):t.tradeObj.recipient.chanceJailCard&&((i=b.appendChild(document.createElement("tr"))).addEventListener("click",u),(o=i.appendChild(document.createElement("td"))).className="propertycellcheckbox",(l=o.appendChild(document.createElement("input"))).type="checkbox",l.id="traderightcheckbox41",l.title="Check this box to include this Get Out of Jail Free Card in the trade.",(o=i.appendChild(document.createElement("td"))).className="propertycellcolor",o.style.backgroundColor="white",o.style.borderColor="grey",(o=i.appendChild(document.createElement("td"))).className="propertycellname",o.textContent="Get Out of Jail Free Card"),console.assert(!1),g.lastChild?m.appendChild(g):m.textContent=t.tradeObj.initiator.name+" has no properties to trade.",b.lastChild?h.appendChild(b):h.textContent=t.tradeObj.recipient.name+" has no properties to trade.",t.this.getElementById("trade-leftp-name").textContent=t.tradeObj.initiator.name,p=t.this.getElementById("trade-rightp-name"),e.allowRecipientToBeChanged&&t.pcount>2){for(;p.lastChild;)p.removeChild(p.lastChild);d=p.appendChild(document.createElement("select"));for(let e=1;e<=t.pcount;e++)e!==t.tradeObj.initiator.index&&((s=d.appendChild(document.createElement("option"))).value=e+"",s.style.color=t.player[e].color,s.textContent=t.player[e].name,e===t.tradeObj.recipient.index&&(s.selected="selected"));d.onchange=async function(e){let r=parseInt(e.target.value,10);await mInterface.get({type:"getTrade"},t),t.tradeObj.recipient=t.player[r],t.tradeObj.currentRecipient=t.player[r],await gameplay.get({type:"resetTrade",initiator:t.tradeObj.currentInitiator,recipient:t.player[r],allowRecipientToBeChanged:!0},t)},d.title="Select a player to trade with."}else p.textContent=t.tradeObj.recipient.name;t.this.getElementById("trade-leftp-money").value="0",t.this.getElementById("trade-leftp-money").addEventListener("input",y),t.this.getElementById("trade-rightp-money").value="0",t.this.getElementById("trade-rightp-money").addEventListener("input",y),n(!0)})(e,t);break;case"addPropertyToAuctionQueue":(async(e,t,r)=>{t.auctionQueue.push(e.propertyIndex)})(e,t);break;case"showdeed":(async(e,t,r)=>{let a=t.square[e.property];t.this.querySelector("#deed").style.display="flex",t.this.querySelector("#deed-normal").style.display="none",t.this.querySelector("#deed-mortgaged").style.display="none",t.this.querySelector("#deed-special").style.display="none",a.mortgage?(t.this.querySelector("#deed-mortgaged").style.display="flex",t.this.getElementById("deed-mortgaged-name").textContent=a.name,t.this.getElementById("deed-mortgaged-mortgage").textContent=a.price/2):a.groupNumber>=3?(t.this.querySelector("#deed-normal").style.display="flex",t.this.getElementById("deed-header").style.backgroundColor=a.color,t.this.getElementById("deed-name").textContent=a.name,t.this.getElementById("deed-baserent").textContent=a.baserent,t.this.getElementById("deed-rent1").textContent=a.rent1,t.this.getElementById("deed-rent2").textContent=a.rent2,t.this.getElementById("deed-rent3").textContent=a.rent3,t.this.getElementById("deed-rent4").textContent=a.rent4,t.this.getElementById("deed-rent5").textContent=a.rent5,t.this.getElementById("deed-mortgage").textContent=a.price/2,t.this.getElementById("deed-houseprice").textContent=a.houseprice,t.this.getElementById("deed-hotelprice").textContent=a.houseprice):2==a.groupNumber?(t.this.querySelector("#deed-special").style.display="flex",t.this.getElementById("deed-special-name").textContent=a.name,t.this.getElementById("deed-special-text").innerHTML=await classicedition.get({type:"utiltext"},t),t.this.getElementById("deed-special-mortgage").textContent=a.price/2):1==a.groupNumber&&(t.this.querySelector("#deed-special").style.display="flex",t.this.getElementById("deed-special-name").textContent=a.name,t.this.getElementById("deed-special-text").innerHTML=await classicedition.get({type:"transtext"},t),t.this.getElementById("deed-special-mortgage").textContent=a.price/2)})(e,t);break;case"auction":(async(e,t,r)=>{if(0===await t.auctionQueue.length)n(!1);else{let e=t.auctionQueue.shift();if(void 0===e);else{let r=t.square[e];if(0===r.price||0!==r.owner)await mInterface.get({type:"auction"},t),n(t);else{t.auctionproperty=e;t.highestbidder=0,t.highestbid=0;t.currentbidder=t.turn+1;let a=t.turn+1;t.currentbidder>t.pcount&&(t.currentbidder-=t.pcount),await mInterface.get({type:"popup",HTML:"\n<div style='font-weight: bold; font-size: 3vw; margin-bottom: 0.977vw;'>\nAuction \n<span id='propertyname'></span>\n</div>\n<div>Highest Bid = $\n<span id='highestbid'></span> (<span id='highestbidder'></span>)\n</div>\n<div>\n<span id='currentbidder'></span>, it is your turn to bid.\n</div>\n<div>\n<input id='bid' title='Enter an amount to bid on \" + s.name + \".' style='width: 85%;' />\n</div>\n<div>\n<input id='auctionBidItem' type='button' value='Bid' title='Place your bid.' />\n<input id='auctionPassItem' type='button' value='Pass' title='Skip bidding this time.'  />\n<input id='exitAuctionItem' type='button' value='Exit Auction' title='Stop bidding on \" + s.name + \" altogether.'  />\n</div>",option:"blank"},t),t.this.getElementById("propertyname").innerHTML=`<a id="propertynameItem" href='javascript:void(0);' class='statscellcolor'>${r.name}</a>`,t.this.querySelector("#propertynameItem").addEventListener("mouseout",async e=>{t.this.querySelector("#deed").style.display="none"}),t.this.querySelector("#propertynameItem").addEventListener("mouseover",async e=>{await mInterface.get({type:"showdeed",property:t.auctionproperty},t)}),t.this.getElementById("highestbid").innerHTML="0",t.this.getElementById("highestbidder").innerHTML="N/A",t.this.getElementById("currentbidder").innerHTML=t.player[t.currentbidder].name,t.this.getElementById("bid").onkeydown=async function(e){let r=0,a=!1,i=!1;return window.event?(r=window.event.keyCode,a=window.event.ctrlKey,i=window.event.shiftKey):e&&(r=e.keyCode,a=e.ctrlKey,i=e.shiftKey),!!isNaN(r)||(13===r&&(await auction.get({type:"auctionBid"},t),n(!1)),!!(8===r||9===r||46===r||r>=35&&r<=40||a)||!i&&void n(r>=48&&r<=57||r>=96&&r<=105))},t.this.getElementById("bid").onfocus=function(){this.style.color="black",isNaN(this.value)&&(this.value="")},await mInterface.get({type:"updateMoney"},t),t.player[a].human||(t.currentbidder=t.turn,await auction.get({type:"auctionPass"},t))}n(!0)}}})(0,t);break;case"getTrade":(async(e,t,r)=>{t.tradeObj=trade.staticProperty,n(t)})(0,t);break;case"setTrade":(async(e,t,r)=>{trade.staticProperty=e.obj,n(t)})(e,t);break;case"trade":(async(e,t,r)=>{trade.staticProperty.initiator=e.initiator,trade.staticProperty.recipient=e.recipient,trade.staticProperty.property=e.property,trade.staticProperty.money=e.money,trade.staticProperty.communityChestJailCard=e.communityChestJailCard,trade.staticProperty.chanceJailCard=e.chanceJailCard,t.tradeObj=trade.staticProperty,t.reversedTrade=trade.staticProperty,await mInterface.get({type:"setTrade",obj:trade.staticProperty},t),n(t)})(e,t);break;case"addEventListener":(async(e,t,r)=>{t.this.querySelector("#resignbutton").addEventListener("click",async e=>{await mInterface.get({type:"resign"},t)}),t.this.querySelector("#proposetradebutton").addEventListener("click",async e=>{if(isNaN(t.this.getElementById("trade-leftp-money").value))t.this.getElementById("trade-leftp-money").value="This value must be a number.",t.this.getElementById("trade-leftp-money").style.color="red",n(!1);else if(isNaN(t.this.getElementById("trade-rightp-money").value))t.this.getElementById("trade-rightp-money").value="This value must be a number.",t.this.getElementById("trade-rightp-money").style.color="red",n(!1);else if(await mInterface.get({type:"readTrade"},t),t.tradeObj.reversedTradeProperty=[],t.tradeObj.money>0&&t.tradeObj.money>t.tradeObj.initiator.money)t.this.getElementById("trade-leftp-money").value=t.tradeObj.initiator.name+" does not have $"+t.tradeObj.money+".",t.this.getElementById("trade-leftp-money").style.color="red",n(!1);else if(t.tradeObj.money<0&&-t.tradeObj.money>t.tradeObj.recipient.money)t.this.getElementById("trade-rightp-money").value=t.tradeObj.recipient.name+" does not have $"+-t.tradeObj.money+".",t.this.getElementById("trade-rightp-money").style.color="red",n(!1);else{console.assert(!1,t),t.tradeObj.isAPropertySelected=0,t.isAPropertySelected=0;for(let e=0;e<40;e++)t.tradeObj.reversedTradeProperty[e]=-t.tradeObj.property[e],-1!==parseInt(t.tradeObj.property[e],10)&&1!==parseInt(t.tradeObj.property[e],10)||(t.isAPropertySelected=1,t.tradeObj.isAPropertySelected=1);if(1!==parseInt(t.tradeObj.communityChestJailCard,10)&&-1!==parseInt(t.tradeObj.communityChestJailCard,10)||(t.isAPropertySelected=1,t.tradeObj.isAPropertySelected=1),1!==parseInt(t.tradeObj.chanceJailCard,10)&&-1!==parseInt(t.tradeObj.chanceJailCard,10)||(t.isAPropertySelected=1,t.tradeObj.isAPropertySelected=1),0===t.isAPropertySelected){let e=t.this.querySelector("#trade");e.querySelector(".errorTrade")||(e.querySelector("tbody").insertAdjacentHTML("afterbegin",'<tr class="errorTrade"><td class="trade-cell"><p>One or more properties must be selected in order to trade.</p></td></tr>'),e.querySelector(".trade-cell").style.color="red"),n(!1)}else if(t.tradeObj.initiator.human&&!confirm(t.tradeObj.initiator.name+", are you sure you want to make this offer to "+t.tradeObj.recipient.name+"?"))n(!1);else if(await mInterface.get({type:"trade",recipient:t.tradeObj.initiator,initiator:t.tradeObj.recipient,money:-t.tradeObj.money,property:t.tradeObj.reversedTradeProperty,communityChestJailCard:t.tradeObj.communityChestJailCard,chanceJailCard:t.tradeObj.chanceJailCard},t),t.tradeObj.recipient.human)await mInterface.get({type:"writeTrade"},t),t.this.querySelector("#proposetradebutton").style.display="none",t.this.querySelector("#canceltradebutton").style.display="none",t.this.querySelector("#accepttradebutton").style.display="flex",t.this.querySelector("#rejecttradebutton").style.display="flex",await mInterface.get({type:"addAlert",value:t.tradeObj.initiator.name+" initiated a trade with "+t.tradeObj.recipient.name+"."},t),await mInterface.get({type:"popup",HTML:"<p>"+t.tradeObj.recipient.name+" has proposed a trade with you, "+t.tradeObj.initiator.name+". You may accept, reject, or modify the offer.</p>"},t);else{let e=recipient.AI.acceptTrade(tradeObj);if(!0===e)popup("<p>"+recipient.name+" has accepted your offer.</p>"),this.acceptTrade(reversedTrade);else{if(!1===e)return void popup("<p>"+recipient.name+" has declined your offer.</p>");e instanceof Trade&&(popup("<p>"+recipient.name+" has proposed a counteroffer.</p>"),writeTrade(e),$("#proposetradebutton, #canceltradebutton").hide(),$("#accepttradebutton").show(),$("#rejecttradebutton").show())}}}}),t.this.querySelector("#canceltradebutton").addEventListener("click",async e=>{t.this.querySelector(".errorTrade")&&t.this.querySelector(".errorTrade").remove(),t.this.querySelector("#board").style.display="flex",t.this.querySelector("#control").style.display="flex",t.this.querySelector("#trade").style.display="none",t.this.querySelector("#popupbackground").style.display="none",t.player[t.turn].human||(t.player[t.turn].AI.alertList="",game.next())}),t.this.querySelector("#accepttradebutton").addEventListener("click",async e=>{if(await mInterface.get({type:"getTrade"},t),isNaN(t.this.getElementById("trade-leftp-money").value))t.this.getElementById("trade-leftp-money").value="This value must be a number.",t.this.getElementById("trade-leftp-money").style.color="red",n(!1);else if(isNaN(t.this.getElementById("trade-rightp-money").value))t.this.getElementById("trade-rightp-money").value="This value must be a number.",t.this.getElementById("trade-rightp-money").style.color="red",n(!1);else if(t.showAlerts=!0,t.tradeObj?t.showAlerts=!1:await mInterface.get({type:"readTrade"},t),t.tradeObj.money>0&&t.tradeObj.money>t.tradeObj.initiator.money)t.this.getElementById("trade-leftp-money").value=t.tradeObj.initiator.name+" does not have $"+t.tradeObj.money+".",t.this.getElementById("trade-leftp-money").style.color="red",n(!1);else if(t.tradeObj.money<0&&-t.tradeObj.money>t.tradeObj.recipient.money)t.this.getElementById("trade-rightp-money").value=t.tradeObj.recipient.name+" does not have $"+-t.tradeObj.money+".",t.this.getElementById("trade-rightp-money").style.color="red",n(!1);else{let e=0;t.tradeObj.isAPropertySelected=0;for(let r=0;r<40;r++)1!==parseInt(t.tradeObj.property[r],10)&&-1!==parseInt(t.tradeObj.property[r],10)||(e=1,t.tradeObj.isAPropertySelected=1);if(1!==parseInt(t.tradeObj.communityChestJailCard,10)&&-1!==parseInt(t.tradeObj.communityChestJailCard,10)||(t.tradeObj.isAPropertySelected=1,e=1),1!==parseInt(t.tradeObj.chanceJailCard,10)&&-1!==parseInt(t.tradeObj.chanceJailCard,10)||(t.tradeObj.isAPropertySelected=1,e=1),0===t.tradeObj.isAPropertySelected)await mInterface.get({type:"popup",HTML:"<p>One or more properties must be selected in order to trade.</p>"},t),n(!1);else if(confirm(t.tradeObj.initiator.name+", are you sure you want to make this exchange with "+t.tradeObj.recipient.name+"?")){for(let e=0;e<40;e++)1===t.tradeObj.property[e]?(t.square[e].owner=t.tradeObj.recipient.index,await mInterface.get({type:"addAlert",value:t.tradeObj.recipient.name+" received "+t.square[e].name+" from "+t.tradeObj.initiator.name+"."},t)):-1===t.tradeObj.property[e]&&(t.square[e].owner=t.tradeObj.initiator.index,await mInterface.get({type:"addAlert",value:t.tradeObj.initiator.name+" received "+t.square[e].name+" from "+t.tradeObj.recipient.name+"."},t));1===t.tradeObj.communityChestJailCard?(t.tradeObj.initiator.communityChestJailCard=!1,t.tradeObj.recipient.communityChestJailCard=!0,await mInterface.get({type:"addAlert",value:t.tradeObj.recipient.name+' received a "Get Out of Jail Free" card from '+t.tradeObj.initiator.name+"."},t)):-1===t.tradeObj.communityChestJailCard&&(t.tradeObj.initiator.communityChestJailCard=!0,t.tradeObj.recipient.communityChestJailCard=!1,await mInterface.get({type:"addAlert",value:t.tradeObj.initiator.name+' received a "Get Out of Jail Free" card from '+t.tradeObj.recipient.name+"."},t)),1===t.tradeObj.chanceJailCard?(t.tradeObj.initiator.chanceJailCard=!1,t.tradeObj.recipient.chanceJailCard=!0,await mInterface.get({type:"addAlert",value:t.tradeObj.recipient.name+' received a "Get Out of Jail Free" card from '+t.tradeObj.initiator.name+"."},t)):-1===t.tradeObj.chanceJailCard&&(t.tradeObj.initiator.chanceJailCard=!0,t.tradeObj.recipient.chanceJailCard=!1,await mInterface.get({type:"addAlert",value:t.tradeObj.initiator.name+' received a "Get Out of Jail Free" card from '+t.tradeObj.recipient.name+"."},t)),t.tradeObj.money>0?(t.tradeObj.initiator.pay(t.tradeObj.money,t.tradeObj.recipient.index,t),t.tradeObj.recipient.money+=t.tradeObj.money,await mInterface.get({type:"addAlert",value:t.tradeObj.recipient.name+" received $"+t.tradeObj.money+" from "+t.tradeObj.initiator.name+"."},t)):t.tradeObj.money<0&&(t.tradeObj.money=-t.tradeObj.money,t.tradeObj.recipient.pay(t.tradeObj.money,t.tradeObj.initiator.index,t),t.tradeObj.initiator.money+=t.tradeObj.money,await mInterface.get({type:"addAlert",value:t.tradeObj.initiator.name+" received $"+t.tradeObj.money+" from "+t.tradeObj.recipient.name+"."},t)),await gameplay.get({type:"updateOwned",value:""},t),await gameplay.get({type:"updateMoney"},t),t.this.querySelector("#trade").style.display="none",t.this.querySelector("#popupbackground").style.display="none",t.player[t.turn].human||(t.player[t.turn].AI.alertList="",game.next())}else n(!1)}}),t.this.querySelector("#rejecttradebutton").addEventListener("click",async e=>{t.this.querySelector("#trade").style.display="none",t.this.querySelector("#popupbackground").style.display="none",t.player[t.turn].human||(t.player[t.turn].AI.alertList="",game.next())})})(0,t);break;case"land":(async(e,t,r)=>{e.increasedRent=!!e.increasedRent;let a=t.player[t.turn],i=t.square[a.position],o=t.die1,l=t.die2;if(t.this.querySelector("#landed").style.display="flex",t.this.querySelector("#landed").innerHTML="You landed on "+i.name+".",i.landcount++,await mInterface.get({type:"addAlert",value:`${a.name} landed on ${i.name}.`},t),0!==i.price&&0===i.owner&&(a.human?(t.this.querySelector("#landed").innerHTML="<div>You landed on <a href='javascript:void(0);' id='previeCard' class='statscellcolor'>"+i.name+".</a><input type='button' id='buyCards' value='Buy ($"+i.price+")' title='Buy "+i.name+" for "+i.pricetext+".'/></div>",t.this.querySelector("#buyCards").addEventListener("click",async e=>{let r=t.player[t.turn],a=t.square[r.position],n=a.price;if(r.money>=n){let e=[];for(let a=0;a<t.auctionQueue.length;a++)t.auctionQueue[a]===r.position||e.push(t.auctionQueue[a]);t.auctionQueue=e,r.pay(n,0,t),a.owner=t.turn,await mInterface.get({type:"updateMoney"},t),await mInterface.get({type:"addAlert",value:`${r.name} bought ${a.name} for ${a.pricetext}.`},t),await mInterface.get({type:"updateOwned"},t),t.this.querySelector("#landed").style.display="none"}else await mInterface.get({type:"popup",HTML:"<p>"+r.name+", you need $"+(a.price-r.money)+" more to buy "+a.name+".</p>"},t)}),t.this.querySelector("#previeCard").addEventListener("mouseover",async e=>{let r=t.player[t.turn],a=t.square[r.position];t.this.querySelector("#deed").style.display="flex",t.this.querySelector("#deed-special").style.display="none",t.this.querySelector("#deed-normal").style.display="none",t.this.querySelector("#deed-mortgaged").style.display="none",a.mortgage?(t.this.querySelector("#deed-mortgaged").style.display="flex",t.this.getElementById("deed-mortgaged-name").textContent=a.name,t.this.getElementById("deed-mortgaged-mortgage").textContent=a.price/2):a.groupNumber>=3?(t.this.querySelector("#deed-normal").style.display="flex",t.this.getElementById("deed-header").style.backgroundColor=a.color,t.this.getElementById("deed-name").textContent=a.name,t.this.getElementById("deed-baserent").textContent=a.baserent,t.this.getElementById("deed-rent1").textContent=a.rent1,t.this.getElementById("deed-rent2").textContent=a.rent2,t.this.getElementById("deed-rent3").textContent=a.rent3,t.this.getElementById("deed-rent4").textContent=a.rent4,t.this.getElementById("deed-rent5").textContent=a.rent5,t.this.getElementById("deed-mortgage").textContent=a.price/2,t.this.getElementById("deed-houseprice").textContent=a.houseprice,t.this.getElementById("deed-hotelprice").textContent=a.houseprice):2==a.groupNumber?(t.this.querySelector("#deed-special").style.display="flex",t.this.getElementById("deed-special-name").textContent=a.name,t.this.getElementById("deed-special-text").innerHTML=await classicedition.get({type:"utiltext"},t),t.this.getElementById("deed-special-mortgage").textContent=a.price/2):1==a.groupNumber&&(t.this.querySelector("#deed-special").style.display="flex",t.this.getElementById("deed-special-name").textContent=a.name,t.this.getElementById("deed-special-text").innerHTML=await classicedition.get({type:"transtext"},t),t.this.getElementById("deed-special-mortgage").textContent=a.price/2)}),t.this.querySelector("#previeCard").addEventListener("mouseout",e=>{t.this.querySelector("#deed").style.display="none"})):a.AI.buyProperty(a.position)&&await mInterface.get({type:"buy"},t),await mInterface.get({type:"addPropertyToAuctionQueue",propertyIndex:a.position},t)),0===i.owner||i.owner==t.turn||i.mortgage)i.owner>0&&i.owner!=t.turn&&i.mortgage&&(t.this.getElementById("landed").innerHTML="You landed on "+i.name+". Property is mortgaged; no rent was collected.");else{let r,n=!0;if(t.groupowned=!0,5==a.position||15==a.position||25==a.position||35==a.position)e.increasedRent?(r=25,t.rent=25):(t.rent=12.5,r=12.5),i.owner==t.square[5].owner&&(r*=2,t.rent*=2),i.owner==t.square[15].owner&&(r*=2,t.rent*=2),i.owner==t.square[25].owner&&(r*=2,t.rent*=2),i.owner==t.square[35].owner&&(r*=2,t.rent*=2);else if(12===a.position)e.increasedRent||t.square[28].owner==i.owner?(r=10*(o+l),t.rent=10*(o+l)):(r=4*(o+l),t.rent=4*(o+l));else if(28===a.position)e.increasedRent||t.square[12].owner==i.owner?(r=10*(o+l),t.rent=10*(o+l)):(r=4*(o+l),t.rent=4*(o+l));else{for(let e=0;e<40;e++){let r=t.square[e];r.groupNumber==i.groupNumber&&r.owner!=i.owner&&(n=!1,t.groupowned=!1)}n?0===i.house?(r=2*i.baserent,t.rent=2*i.baserent):(r=i["rent"+i.house],t.rent=i["rent"+i.house]):(r=i.baserent,t.rent=i.baserent)}await mInterface.get({type:"addAlert",value:`${a.name} paid $" ${r} rent to. ${t.player[i.owner].name}`},t),a.pay(r,i.owner,t),t.player[i.owner].money+=r,t.this.getElementById("landed").innerHTML="You landed on "+i.name+". "+t.player[i.owner].name+" collected $"+r+" rent."}4===a.position&&await mInterface.get({type:"citytax"},t),30===a.position&&(await mInterface.get({type:"updateMoney"},t),await mInterface.get({type:"updatePosition"},t),a.human?await mInterface.get({type:"popup",HTML:"<div>Go to jail. Go directly to Jail. Do not pass GO. Do not collect $200.</div>",action:async(e,t)=>{await mInterface.get({type:"gotojail"},t)},option:null},t):await mInterface.get({type:"gotojail"},t),n(t)),38===a.position&&await mInterface.get({type:"luxurytax"},t),await mInterface.get({type:"updateMoney"},t),await mInterface.get({type:"updatePosition"},t),await mInterface.get({type:"updateOwned"},t),a.human?await mInterface.get({type:"chanceCommunityChest"},t):(popup(a.AI.alertList,chanceCommunityChest),a.AI.alertList=""),n(t)})(e,t);break;case"subtractamount":(async(e,t,r)=>{let a=t.player[t.turn];a.pay(e.amount,0,t),await mInterface.get({type:"addAlert",value:`${a.name} lost $ ${e.amount} from ${e.cause}.`},t),n(t)})(e,t);break;case"gobackthreespaces":(async(e,t,r)=>{t.player[t.turn].position-=3,await gameplay.get({type:"land"},t),n(t)})(0,t);break;case"advanceToNearestUtility":(async(e,t,r)=>{let a=t.player[t.turn];a.position<12?a.position=12:a.position>=12&&a.position<28?a.position=28:a.position>=28&&(a.position=12,a.money+=200,await mInterface.get({type:"addAlert",value:`${a.name} collected a $200 salary for passing GO.`},t)),await gameplay.get({type:"land",increasedRent:!0},t),n(t)})(0,t);break;case"advanceToNearestRailroad":(async(e,t,r)=>{let a=t.player[t.turn];await mInterface.get({type:"updatePosition"},t),a.position<15?a.position=15:a.position>=15&&a.position<25?a.position=25:a.position>=35&&(a.position=5,a.money+=200,await mInterface.get({type:"addAlert",value:`${a.name} collected a $200 salary for passing GO.`},t)),await mInterface.get({type:"land",increasedRent:!0},t),n(t)})(0,t);break;case"payeachplayer":(async(e,t,r)=>{let a=t.player[t.turn],i=0;for(let r=1;r<=t.pcount;r++)r!=t.turn&&(t.player[r].money+=e.amount,i+=e.amount,e.creditor=a.money>=0?r:e.creditor,a.pay(e.amount,e.creditor,t));await mInterface.get({type:"addAlert",value:`${a.name}  lost $ ${i} from ${e.cause}.`},t),n(t)})(e,t);break;case"addamount":(async(e,t,r)=>{let a=t.player[t.turn];a.money+=e.amount,await mInterface.get({type:"addAlert",value:`${a.name} received $ ${e.amount} from ${e.cause}.`},t),n(t)})(e,t);break;case"gotojail":(async(e,t,r)=>{let a=t.player[t.turn];await mInterface.get({type:"addAlert",value:`${a.name}  was sent directly to jail.`},t),t.this.getElementById("landed").innerHTML="You are in jail.",a.jail=!0,t.doublecount=0,t.this.getElementById("nextbutton").value="End turn",t.this.getElementById("nextbutton").title="End turn and advance to the next player.",a.human&&t.this.getElementById("nextbutton").focus(),await mInterface.get({type:"updatePosition"},t),await mInterface.get({type:"updateOwned"},t),a.human||(console.assert(!1,"AI"),a.AI.alertList=""),n(t)})(0,t);break;case"streetrepairs":(async(e,t,r)=>{let a=0;for(let r=0;r<40;r++){let n=t.square[r];n.owner==t.turn&&(1==n.hotel?a+=e.hotelprice:a+=n.house*e.houseprice)}let i=t.player[t.turn];a>0&&(i.pay(a,0,t),40===e.houseprice?await mInterface.get({type:"addAlert",value:`${i.name} lost $ ${a}to Community Chest.`},t):await mInterface.get({type:"addAlert",value:`${i.name} lost $ ${a} to Chance.`},t)),n(t)})(e,t);break;case"rollDice":(async(e,t,r)=>{t.die1=Math.floor(6*Math.random())+1,t.die2=Math.floor(6*Math.random())+1,t.areDiceRolled=!0,n(t)})(0,t);break;case"resetDice":(async(e,t,r)=>{t.areDiceRolled=!1,n(t)})(0,t);break;case"getDie":(async(e,t,r)=>{1===e.value?n(t.die1):n(t.die2)})(e,t);break;case"updateDice":(async(e,t,r)=>{let a=t.die1,i=t.die2;if(t.this.querySelector("#die0").style.display="flex",t.this.querySelector("#die1").style.display="flex",t.this.images){var o=t.this.getElementById("die0"),l=t.this.getElementById("die1");o.classList.remove("die-no-img"),l.classList.remove("die-no-img"),o.title="Die ("+a+" spots)",l.title="Die ("+i+" spots)",o=o.firstChild?o.firstChild:o.appendChild(document.createElement("img")),console.assert(!1),o.src="/images/Die_"+a+".png",o.alt=a,(l=l.firstChild?l.firstChild:l.appendChild(document.createElement("img"))).src="images/Die_"+i+".png",l.alt=a}else t.this.getElementById("die0").textContent=a,t.this.getElementById("die1").textContent=i,t.this.getElementById("die0").title="Die",t.this.getElementById("die1").title="Die";n(t)})(0,t);break;case"updateMoney":(async(e,t,r)=>{var a=t.player[t.turn];t.this.getElementById("pmoney").innerHTML="$"+a.money,t.this.querySelector(".money-bar-row").style.display="none";for(var i=1;i<=t.pcount;i++){let e=t.player[i];t.this.querySelector(`#moneybarrow${i}`).style.display="flex",t.this.getElementById("p"+i+"moneybar").style.border="2px solid "+e.color,t.this.getElementById("p"+i+"money").innerHTML=e.money,t.this.getElementById("p"+i+"moneyname").innerHTML=e.name}""===t.this.getElementById("landed").innerHTML&&(t.this.querySelector("#landed").style.display="none"),t.this.getElementById("quickstats").style.borderColor=a.color,a.money<0?(t.this.querySelector("#resignbutton").style.display="flex",t.this.querySelector("#nextbutton").style.display="none"):(t.this.querySelector("#resignbutton").style.display="none",t.this.querySelector("#nextbutton").style.display="flex"),n(t)})(0,t);break;case"addAlert":(async(e,t,r)=>{let a=t.this.querySelector("#alert"),i=document.createElement("div");i.innerText=e.value,a.appendChild(i),t.player[t.turn].human,n(t)})(e,t);break;case"popup":(async(e,t,r)=>{t.this.getElementById("popuptext").innerHTML=e.HTML,t.this.getElementById("popup").style.width="61.297vw",t.this.getElementById("popup").style.height="16.297vw;",t.this.getElementById("popup").style.top="0",t.this.getElementById("popup").style.left="0",e.option||"string"!=typeof e.action||(e.option=e.action),e.option=e.option?e.option.toLowerCase():"","function"!=typeof e.action&&(e.action=null),"yes/no"===e.option?(t.this.getElementById("popuptext").innerHTML+='<div><input type="button" value="Yes" id="popupyes" /><input type="button" value="No" id="popupno" /></div>',t.this.querySelector("#popupyes").addEventListener("click",async()=>{t.this.querySelector("#popupwrap").style.display="none",t.this.querySelector("#popupbackground").style.display="none",e.action(e,t)}),t.this.querySelector("#popupno").addEventListener("click",async()=>{t.this.querySelector("#popupwrap").style.display="none",t.this.querySelector("#popupbackground").style.display="none"})):"blank"!==e.option&&(t.this.querySelector(".containerCard")?t.this.querySelector(".containerCard").insertAdjacentHTML("beforeend","<div><input type='button' value='OK' id='popupclose' /></div>"):t.this.querySelector("#popuptext").insertAdjacentHTML("beforeend","<div><input type='button' value='OK' id='popupclose' /></div>"),t.this.querySelector("#popupclose").focus(),t.this.querySelector("#popupclose").addEventListener("click",async()=>{t.this.querySelector("#popupwrap").style.display="none",null===e.action?e.HTML.indexOf("Go to jail")>-1?t.this.querySelector("#popupbackground").style.display="none":e.HTML.indexOf("more to buy")>-1&&(t.this.querySelector("#popupbackground").style.display="none"):(t.this.querySelector("#popupbackground").style.display="none",e.action(e,t))})),t.this.querySelector("#popupwrap").style.display="flex",t.this.querySelector("#popupbackground").style.display="flex",t.this.querySelector("#auctionBidItem")&&t.this.querySelector("#auctionBidItem").addEventListener("click",async()=>{await auction.get({type:"auctionBid",bid:null},t)}),t.this.querySelector("#auctionPassItem")&&t.this.querySelector("#auctionPassItem").addEventListener("click",async()=>{await auction.get({type:"auctionPass"},t)}),t.this.querySelector("#exitAuctionItem")&&t.this.querySelector("#exitAuctionItem").addEventListener("click",async()=>{confirm("Are you sure you want to stop bidding on this property altogether?")&&await auction.get({type:"auctionExit"},t)}),t.this.querySelector("#popupwrap").style.display="flex",n(t)})(e,t);break;case"updatePosition":(async(e,t,r)=>{t.this.getElementById("jail").style.border="0.098vw solid black",t.this.querySelector("#jailpositionholder")&&(t.this.querySelector("#jailpositionholder").innerHTML="");for(let e=0;e<40;e++)t.this.getElementById("cell"+e).style.border="0.098vw solid black",t.this.getElementById("cell"+e+"positionholder").innerHTML="";let a,i,o;for(let e=0;e<40;e++){a=t.square[e],i=0,o=0;for(let r=t.turn;r<=t.pcount;r++)t.player[r].position!==e||t.player[r].jail||(t.this.getElementById("cell"+e+"positionholder").innerHTML+="<div class='cell-position' title='"+t.player[r].name+"' style='background-color: "+t.player[r].color+"; left: "+i+"vw; top: "+o+"px;'></div>",36==i?(i=0,o=12):i+=1.2);for(let r=1;r<t.turn;r++)t.player[r].position!=e||t.player[r].jail||(t.this.getElementById("cell"+e+"positionholder").innerHTML+="<div class='cell-position' title='"+t.player[r].name+"' style='background-color: "+t.player[r].color+"; left: "+i+"vw; top: "+o+"px;'></div>",36==i?(i=0,o=12):i+=1.2)}i=0,o=5.2;for(let e=t.turn;e<=t.pcount;e++)t.player[e].jail&&(t.this.getElementById("jailpositionholder").innerHTML+="<div class='cell-position' title='"+t.player[e].name+"' style='background-color: "+t.player[e].color+"; left: "+i+"vw; top: "+o+"vw;'></div>",36===i?(i=0,o=41):i+=1.2);for(let e=1;e<t.turn;e++)t.player[e].jail&&(t.this.getElementById("jailpositionholder").innerHTML+="<div class='cell-position' title='"+t.player[e].name+"' style='background-color: "+t.player[e].color+"; left: "+i+"vw; top: "+o+"vw;'></div>",36===i?(i=0,o=41):i+=1.2);let l=t.player[t.turn];l.jail?t.this.getElementById("jail").style.border="0.098vw solid "+l.color:t.this.getElementById("cell"+l.position).style.border="0.098vw solid "+l.color,n(t)})(0,t);break;case"updateOwned":(async(e,t,r)=>{let a=t.player[t.turn],i=(()=>{for(let e=0;e<42;e++)if(t.this.getElementById("propertycheckbox"+e)&&t.this.getElementById("propertycheckbox"+e).checked)return e;return-1})();t.checkedproperty=i,t.this.querySelector("#option").style.display="flex",t.this.querySelector("#owned").style.display="flex";let o,l="",d=-1,s="",c="";for(let e=0;e<40;e++)if((o=t.square[e]).groupNumber&&0===o.owner)t.this.querySelector(`#cell${e}owner`).style.display="none";else if(o.groupNumber&&o.owner>0){let r=t.this.getElementById("cell"+e+"owner");r.style.display="block",r.style.backgroundColor=t.player[o.owner].color,r.title=t.player[o.owner].name}for(let e=0;e<40;e++)if((o=t.square[e]).owner==t.turn){if(s="",o.mortgage&&(s="title='Mortgaged' style='color: grey;'"),c="",o.house>=1&&o.house<=4)for(let e=1;e<=o.house;e++)c+="<img src='./static/html/components/main-manager/images/house.png' alt='' title='House' class='house' />";else o.hotel&&(c+="<img src='./static/html/components/main-manager/images/house.png' alt='' title='Hotel' class='hotel' />");""===l&&(l+="<table>",d=e),l+="<tr class='property-cell-row'><td class='propertycellcheckbox'><input type='checkbox' id='propertycheckbox"+e+"' /></td><td class='propertycellcolor' style='background: "+o.color+";",1!=o.groupNumber&&2!=o.groupNumber||(l+=" border: 0.098vw solid grey; width: 1.758vw;"),l+="' showdeed = "+e+" ></td> <td class = 'propertycellname' > "+o.name+c+"</td> </tr>"}if(a.communityChestJailCard&&(""===l&&(d=40,l+="<table>"),l+="<tr class='property-cell-row'><td class='propertycellcheckbox'><input type='checkbox' id='propertycheckbox40' /></td><td class='propertycellcolor' style='background: white;'></td><td class='propertycellname'>Get Out of Jail Free Card</td></tr>"),a.chanceJailCard&&(""===l&&(d=41,l+="<table>"),l+="<tr class='property-cell-row'><td class='propertycellcheckbox'><input type='checkbox' id='propertycheckbox41' /></td><td class='propertycellcolor' style='background: white;'></td><td class='propertycellname'>Get Out of Jail Free Card</td></tr>"),""===l?(l=a.name+", you don't have any properties.",t.this.querySelector("#option").style.display="none"):l+="</table>",t.this.getElementById("owned").innerHTML=l,t.this.querySelector(".propertycellcolor")){let e=t.this.querySelectorAll(".propertycellcolor");for(let r=0;r<e.length;r++)e[r].addEventListener("mouseover",async a=>{let n=e[r].getAttribute("showdeed");await mInterface.get({type:"showdeed",property:n},t)}),e[r].addEventListener("mouseout",async e=>{t.this.querySelector("#deed").style.display="none"})}i>-1&&t.this.getElementById("propertycheckbox"+i)?t.this.getElementById("propertycheckbox"+i).checked=!0:d>-1&&(t.this.getElementById("propertycheckbox"+d).checked=!0);let p=t.this.querySelectorAll(".property-cell-row");for(let e=0;e<p.length;e++)p[e].addEventListener("click",async e=>{let r=!0,a=e.target.parentNode,n={},i=!1;for(;r;)"TR"===a.tagName?(i=a,a=a.parentNode):"TBODY"===a.tagName?(n=a,r=!1):a=a.parentNode;if(i){for(let e=0;e<n.children.length;e++)n.children[e].querySelector("input").checked=!1;i.querySelector("input").checked=!0}else;await mInterface.get({type:"updateOption"},t)});await mInterface.get({type:"updateOption"},t),n(t)})(0,t);break;case"updateOption":(async(e,t,r)=>{t.this.querySelector("#option").style.display="flex";let a=!0,i=!0,o=(()=>{for(let e=0;e<42;e++)if(t.this.getElementById("propertycheckbox"+e)&&t.this.getElementById("propertycheckbox"+e).checked)return e;return-1})();if(o<0||o>=40){t.this.querySelector("#buyhousebutton").style.display="none",t.this.querySelector("#sellhousebutton").style.display="none",t.this.querySelector("#mortgagebutton").style.display="none";let e=32,r=12;for(let a=0;a<40;a++){let n=t.square[a];1==n.hotel?r--:e-=n.house}t.this.querySelector("#buildings").style.display="flex",t.this.getElementById("buildings").innerHTML="<img src='./static/html/components/main-manager/images/house.png' alt='' title='House' class='house' />:&nbsp;"+e+"&nbsp;&nbsp;<img src='./static/html/components/main-manager/images/hotel.png' alt='' title='Hotel' class='hotel' />:&nbsp;"+r,n(t)}else{t.this.querySelector("#buildings").style.display="none";let e=t.square[o],r=t.this.getElementById("buyhousebutton"),l=t.this.getElementById("sellhousebutton");if(t.this.querySelector("#mortgagebutton").style.display="flex",t.this.getElementById("mortgagebutton").disabled=!1,e.mortgage)t.this.getElementById("mortgagebutton").value="Unmortgage ($"+Math.round(.6*e.price)+")",t.this.getElementById("mortgagebutton").title="Unmortgage "+e.name+" for $"+Math.round(.6*e.price)+".",t.this.querySelector("#buyhousebutton").style.display="none",t.this.querySelector("#sellhousebutton").style.display="none",i=!1;else if(t.this.getElementById("mortgagebutton").value="Mortgage ($"+.5*e.price+")",t.this.getElementById("mortgagebutton").title="Mortgage "+e.name+" for $"+.5*e.price+".",e.groupNumber>=3){t.this.querySelector("#buyhousebutton").style.display="flex",t.this.querySelector("#sellhousebutton").style.display="flex",r.disabled=!1,l.disabled=!1,r.value="Buy house ($"+e.houseprice+")",l.value="Sell house ($"+.5*e.houseprice+")",r.title="Buy a house for $"+e.houseprice,l.title="Sell a house for $"+.5*e.houseprice,4==e.house&&(r.value="Buy hotel ($"+e.houseprice+")",r.title="Buy a hotel for $"+e.houseprice),1==e.hotel&&(t.this.querySelector("#buyhousebutton").style.display="none",l.value="Sell hotel ($"+.5*e.houseprice+")",l.title="Sell a hotel for $"+.5*e.houseprice);let o=0,d=5,s=e.group.length;for(let n=0;n<s;n++){let s=t.square[e.group[n]];s.owner!==e.owner?(r.disabled=!0,l.disabled=!0,r.title="Before you can buy a house, you must own all the properties of this color-group."):(s.house>o&&(o=s.house),s.house<d&&(d=s.house),s.house>0&&(a=!1),s.mortgage&&(i=!1))}i||(r.disabled=!0,r.title="Before you can buy a house, you must unmortgage all the properties of this color-group."),e.house>d&&(r.disabled=!0,1==e.house?r.title="Before you can buy another house, the other properties of this color-group must all have one house.":4==e.house?r.title="Before you can buy a hotel, the other properties of this color-group must all have 4 houses.":r.title="Before you can buy a house, the other properties of this color-group must all have "+e.house+" houses."),e.house<o&&(l.disabled=!0,1==e.house?l.title="Before you can sell house, the other properties of this color-group must all have one house.":l.title="Before you can sell a house, the other properties of this color-group must all have "+e.house+" houses."),0===e.house&&0===e.hotel?t.this.querySelector("#sellhousebutton").style.display="none":t.this.querySelector("#mortgagebutton").style.display="none",a||(t.this.getElementById("mortgagebutton").title="Before a property can be mortgaged, all the properties of its color-group must unimproved.",t.this.getElementById("mortgagebutton").disabled=!0),n(t)}else t.this.querySelector("#buyhousebutton").style.display="none",t.this.querySelector("#sellhousebutton").style.display="none",n(t);n(t)}})(0,t);break;case"advance":(async(e,t,r)=>{let a=t.player[t.turn];"number"==typeof e.pass&&(a.position<e.pass?a.position=e.pass:(a.position=e.pass,a.money+=200,await mInterface.get({type:"addAlert",value:`${a.name} collected a $200 salary for passing GO. `},t))),a.position<e.destination?a.position=e.destination:(a.position=e.destination,a.money+=200,await mInterface.get({type:"addAlert",value:`${a.name} collected a $200 salary for passing GO.`},t)),await gameplay.get({type:"land"},t)})(e,t);break;default:console.assert(!1,`Новая функция ${e.type}`)}}),auction:(e,t,...r)=>new Promise((r,a)=>{function n(e){r(e)}switch(e.type){case"finalizeAuction":(async(e,t,r)=>{let a=t.player[t.highestbidder],i=t.square[t.auctionproperty];t.highestbid>0&&(a.pay(t.highestbid,0,t),i.owner=t.highestbidder,await mInterface.get({type:"addAlert",value:`${a.name} bought ${i.name} for $ ${t.highestbid}.`},t));for(let e=1;e<=t.pcount;e++)t.player[e].bidding=!0;t.this.querySelector("#popupbackground").style.display="none",t.this.querySelector("#popupwrap").style.display="none",await mInterface.auction({type:"auction"},t)||await gameplay.get({type:"play",player:a},t),n(t)})(0,t);break;case"auction":(async(e,t,r)=>{if(0===await t.auctionQueue.length)n(!1);else{let e=t.auctionQueue.shift();if(void 0===e);else{let r=t.square[e];if(0===r.price||0!==r.owner)n(await mInterface.get({type:"auction"},t));else{t.auctionproperty=e;t.highestbidder=0,t.highestbid=0;t.currentbidder=t.turn+1;let a=t.turn+1;t.currentbidder>t.pcount&&(t.currentbidder-=t.pcount),await mInterface.get({type:"popup",HTML:"\n<div style='font-weight: bold; font-size: 3vw; margin-bottom: 0.977vw;'>\nAuction \n<span id='propertyname'></span>\n</div>\n<div>Highest Bid = $\n<span id='highestbid'></span> (<span id='highestbidder'></span>)\n</div>\n<div>\n<span id='currentbidder'></span>, it is your turn to bid.\n</div>\n<div>\n<input id='bid' title='Enter an amount to bid on \" + s.name + \".' style='width: 85%;' />\n</div>\n<div>\n<input id='auctionBidItem' type='button' value='Bid' title='Place your bid.' />\n<input id='auctionPassItem' type='button' value='Pass' title='Skip bidding this time.'  />\n<input id='exitAuctionItem' type='button' value='Exit Auction' title='Stop bidding on \" + s.name + \" altogether.'  />\n</div>",option:"blank"},t),t.this.getElementById("propertyname").innerHTML=`<a id="propertynameItem" href='javascript:void(0);' class='statscellcolor'>${r.name}</a>`,t.this.querySelector("#propertynameItem").addEventListener("mouseout",async e=>{t.this.querySelector("#deed").style.display="none"}),t.this.querySelector("#propertynameItem").addEventListener("mouseover",async e=>{await mInterface.get({type:"showdeed",property:t.auctionproperty},t)}),t.this.getElementById("highestbid").innerHTML="0",t.this.getElementById("highestbidder").innerHTML="N/A",t.this.getElementById("currentbidder").innerHTML=t.player[a].name,t.this.getElementById("bid").onkeydown=async function(e){let r=0,a=!1,i=!1;if(window.event?(r=window.event.keyCode,a=window.event.ctrlKey,i=window.event.shiftKey):e&&(r=e.keyCode,a=e.ctrlKey,i=e.shiftKey),isNaN(r))return!0;13===r?(await auction.get({type:"auctionBid"},t),n(!1)):n(!!(8===r||9===r||46===r||r>=35&&r<=40||a)||!i&&(r>=48&&r<=57||r>=96&&r<=105))},t.this.getElementById("bid").onfocus=function(){this.style.color="black",isNaN(this.value)&&(this.value="")},await mInterface.get({type:"updateMoney"},t),t.player[a].human||(t.currentbidder=t.turn,await auction.get({type:"auctionPass"},t))}n(!0)}}})(0,t);break;case"auctionPass":(async(e,t,r)=>{for(0===t.highestbidder&&(t.highestbidder=t.currentbidder);;)if(t.currentbidder++,t.currentbidder>t.pcount&&(t.currentbidder-=t.pcount),t.currentbidder==t.highestbidder)await auction.get({type:"finalizeAuction"},t),n(t);else if(t.player[t.currentbidder].bidding){let e=t.player[t.currentbidder];if(e.human)break;{let r=e.AI.bid(t.auctionproperty,t.highestbid);if(-1===r||t.highestbid>=e.money){e.bidding=!1,window.alert(e.name+" exited the auction.");continue}if(0===r){window.alert(e.name+" passed.");continue}if(r>0){t.bid=r,await auction.get({type:"auctionBid",bid:r},t),window.alert(e.name+" bid $"+r+".");continue}n(t)}}t.this.getElementById("currentbidder").innerHTML=t.player[t.currentbidder].name,t.this.getElementById("bid").value="",t.this.getElementById("bid").style.color="black"})(0,t)}})};