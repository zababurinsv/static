import staticProperty from"/static/html/components/component_modules/staticProperty/staticProperty.mjs";import setText from"/static/html/components/component_modules/setText/setText.mjs";import addEventListener from"/static/html/components/component_modules/addEventListener/addEventListener.mjs";import templateItem from"/static/html/components/component_modules/template/template.mjs";import store from"/static/html/components/component_modules/staticProperty/staticProperty.mjs";import action from"/static/html/components/component_modules/action/action.mjs";import matcher from"/static/html/components/component_modules/matcher/matcher.mjs";customElements.define("varan-card-news",class extends HTMLElement{static get observedAttributes(){return["feed"]}constructor(){super();let t=[],e=[],n=[],r=[];function a(e,n){return new Promise(function(n,r){if(e.verify=[],e.this.getAttribute("preset"))switch(e.this.getAttribute("preset")){case"default":e["path-template"]=`/static/html/components/${e.component}/template/${e.component}.html`,e.preset=`${e.this.getAttribute("preset")}`,e.verify.preset=!0;break;default:e["path-template"]=`/static/html/components/${e.component}/template/${e.this.getAttribute("preset")}.html`,e.preset=`${e.this.getAttribute("preset")}`,e.verify.preset=!0}else e["path-template"]=`/static/html/components/${e.component}/${e.component}.html`,e.verify.preset=!1;fetch(e["path-template"]).then(function(t){if(t.ok)return t.text()}).then(function(r){let a=(new DOMParser).parseFromString(r,"text/html");e.template=a.getElementsByTagName("template")[0].content.cloneNode(!0),function(e){return new Promise(function(n,r){e["path-external"]=`/static/html/components/${e.component}/external/${e.component}-external.html`,fetch(e["path-external"]).then(function(t){return!1===t.ok?t.ok:t.text()}).then(function(r){if(!1===r);else{let a=new DOMParser,o=a.parseFromString(r,"text/html");e.external=o.querySelectorAll("section"),function(e){return new Promise(function(n,r){e["external-property"]=t["external-property"];let a=[],o=[],i=[];for(let t=0;t<e.external.length;t++){for(let n=0;n<e.external[t].children.length;n++)switch(e.external[t].children[n].tagName){case"SCRIPT":e.external[t].getAttribute("id")&&(o.script=e.external[t].children[n]);break;case"COMPONENT-ID":o.id=e.external[t].children[n].innerText;break;case"COMPONENT-ACTION":for(let r=0;r<e.external[t].children[n].children.length;r++)i.push(e.external[t].children[n].children[r].innerText);o.actions=i}a.push(o),o=[]}e["external-property"]=a,n(e)}).catch(t=>{})}(e).then(t=>{0===t["external-property"].length?n(t):function(t){return new Promise(function(e,n){t["words-action"]=[];let r=[];for(let n=0;n<t["external-property"].length;n++){for(let e=0;e<t["external-property"][n].actions.length;e++)for(let a=0;a<t.words.length;a++)-1!==t["external-property"][n].actions[e].indexOf(t.words[a])&&("shadowRoot"!==t.words[a]&&"shadow"!==t.words[e]||(r.shadow=!0),"light"!==t.words[a]&&"лайт"!==t.words[e]||(r.light=!0),"editor"===t.words[a]&&(r.editor=!0),"слайдер"===t.words[a]&&(r["editor-slider"]=!0),"swap"===t.words[a]&&(r.swap=!0));t["words-action"]=r;for(let e in t["external-property"])for(let n in t["external-property"][e])switch(n){case"id":let r=document.createElement(t["external-property"][e][n]);r.setAttribute("type","external"),t.this.appendChild(r)}e(t)}})}(t).then(t=>{n(t)})})}}).catch(t=>{throw t})})}(e).then(t=>{(function(t,e,n){return new Promise(function(e,n){t["template-shadow"]=[],t["template-light"]=[];let r=[];r.swap=!1,r.blog=!1,r.external=!1,r.light=!1,r.slider=!1,r.one=!1,r.sliderText=!1,r.text=!1;for(let e=0;e<t.type.length;e++){if(-1!==t.type[e].indexOf("slider")&&t.type[e].split("-").length>1){r.slider=!0;for(let n in t.type[e].split("-"))switch(t.type[e].split("-")[n]){case"one":r.one=!0}}if(t.type[e].length)if(t.type[e].split("-").length>1)switch(t.type[e].split("-")[0]){case"blog":r.blog=!0;break;default:console.log("типы не отслеживаются",t.type[e])}else switch(t.type[e]){case"swap":r.swap=!0;break;case"external":r.external=!0;break;case"light":r.light=!0;break;case"slider":r.slider=!0;break;case"sliderText":r.sliderText=!0;break;case"text":r.text=!0}}if(t.this.getAttribute("parent")&&(t.parent=t.this.getAttribute("parent")),!0===r.swap){for(let e=0;e<t.this.children.length;e++)1===t.this.children[e].tagName.split("-").length?("view"===t.this.children[e].slot&&(t.this.children[e].className="wall"),t["template-light"].push(t.this.children[e])):!0===t.getAttribute(t.this.children[e],"light","template")?(t.this.children[e].setAttribute("type",`${t.this.children[e].getAttribute("type")}-external`),!1===t.parent?t.slot?t.this.children[e].setAttribute("parent",`${t.slot}`):t.this.children[e].setAttribute("parent",`${t.component}`):t.this.children[e].setAttribute("parent",`${t.parent}`),o(t.this.children[e],t),t["template-light"].push(t.this.children[e])):(t.this.children[e].setAttribute("type",`${t.this.children[e].getAttribute("type")}-external`),!1===t.parent?t.slot?t.this.children[e].setAttribute("parent",`${t.slot}`):t.this.children[e].setAttribute("parent",`${t.component}`):t.this.children[e].setAttribute("parent",`${t.parent}`),o(t.this.children[e],t),t["template-shadow"].push(t.this.children[e]));for(let e=0;e<t.template.children.length;e++)1===t.template.children[e].tagName.split("-").length?("view"===t.template.children[e].slot&&(t.template.children[e].className="wall"),t["template-light"].push(t.template.children[e])):!0===t.getAttribute(t.template.children[e],"light","template")?(t.template.children[e].setAttribute("type",`${t.template.children[e].getAttribute("type")}-external`),!1===t.parent?t.slot?t.this.children[e].setAttribute("parent",`${t.slot}`):t.this.children[e].setAttribute("parent",`${t.component}`):t.this.children[e].setAttribute("parent",`${t.parent}`),o(t.template.children[e],t),t["template-light"].push(t.template.children[e])):(t.template.children[e].setAttribute("type",`${t.template.children[e].getAttribute("type")}-external`),!1===t.parent?t.slot?t.this.children[e].setAttribute("parent",`${t.slot}`):t.this.children[e].setAttribute("parent",`${t.component}`):t.this.children[e].setAttribute("parent",`${t.parent}`),o(t.template.children[e],t),t["template-shadow"].push(t.template.children[e]))}else{for(let e=0;e<t.this.children.length;e++)1===t.this.children[e].tagName.split("-").length?("view"===t.this.children[e].slot&&(t.this.children[e].className="wall"),t["template-shadow"].push(t.this.children[e])):!0===t.getAttribute(t.this.children[e],"light","template")?(!1===t.parent?t.slot?t.this.children[e].setAttribute("parent",`${t.slot}`):t.this.children[e].setAttribute("parent",`${t.component}`):t.this.children[e].setAttribute("parent",`${t.parent}`),o(t.this.children[e],t),t["template-shadow"].push(t.this.children[e])):(!1===t.parent?t.slot?t.this.children[e].setAttribute("parent",`${t.slot}`):t.this.children[e].setAttribute("parent",`${t.component}`):t.this.children[e].setAttribute("parent",`${t.parent}`),o(t.this.children[e],t),t["template-light"].push(t.this.children[e]));for(let e=0;e<t.template.children.length;e++)1===t.template.children[e].tagName.split("-").length?("view"===t.template.children[e].slot&&(t.template.children[e].className="wall"),t["template-shadow"].push(t.template.children[e])):!0===t.getAttribute(t.template.children[e],"light","template")?(!1===t.parent?t.slot?t.this.children[e].setAttribute("parent",`${t.slot}`):t.this.children[e].setAttribute("parent",`${t.component}`):t.this.children[e].setAttribute("parent",`${t.parent}`),o(t.template.children[e],t),t["template-shadow"].push(t.template.children[e])):(!1===t.parent?t.slot?t.this.children[e].setAttribute("parent",`${t.slot}`):t.this.children[e].setAttribute("parent",`${t.component}`):t.this.children[e].setAttribute("parent",`${t.parent}`),o(t.template.children[e],t),t["template-light"].push(t.template.children[e]))}for(let e in r)t.verify[e]=r[e];e(t)})})(t,t["type-swap"],t["type-external"]).then(t=>{if(!0===t.verify.swap){if(0!==t["template-light"].length)for(let e=0;e<t["template-light"].length;e++)t.this.prepend(t["template-light"][e]);if(0!==t["template-shadow"].length){t.this.attachShadow({mode:"open"}),t.shadowRoot=!0;for(let e=0;e<t["template-shadow"].length;e++)t.this.shadowRoot.appendChild(t["template-shadow"][e])}}else{if(0!==t["template-light"].length)for(let e in t["template-light"])t.this.appendChild(t["template-light"][e]);if(0!==t["template-shadow"].length){t.this.attachShadow({mode:"open"}),t.shadowRoot=!0;for(let e in t["template-shadow"])t.this.shadowRoot.appendChild(t["template-shadow"][e])}}n(t)})})}).catch(t=>t)})}function o(t,e){return new Promise(function(n,r){let a=!1;for(let e=0;e<document.querySelectorAll("script").length;e++)-1!==document.querySelectorAll("script")[e].src.indexOf(t.tagName.toLowerCase())&&(a=!0);if(!0===a)console.log("модуль загружен");else{const a=document.createElement("script");a.src=`/static/html/components/${t.tagName.toLowerCase()}/${t.tagName.toLowerCase()}.mjs`,a.type="module",a.setAttribute("async",""),a.onload=n,a.onerror=r,e.this.appendChild(a)}})}var i;e.push("component-id"),e.push("script"),e.push("component-action"),n.push("h1"),n.push("innerText"),r.push("shadowRoot"),r.push("head"),r.push("shadow"),r.push("light"),r.push("lightDom"),r.push("editor"),r.push("слайдер"),r.push("swap"),t.this=this,t["type-supported"]=n,(i=this,new Promise(function(t,e){let n=[];n.staticProperty=[],n.staticProperty.c=0,n.state=[],n.state.push("shadow"),n.state.push("light"),n.words=r,n.parent=!1,n["type-swap"]=!1,n["type-external"]=!1,n["document-offsetWidth"]=document.body.offsetWidth;let a=!1;if(n.getAttribute=((t,e,n)=>{if("template"===n){if(!t.getAttribute("type"))return t.setAttribute("type","default"),!1;for(let n=0;n<t.getAttribute("type").split("-").length;n++)t.getAttribute("type").split("-")[n]===e&&(a=!0);return a}if(t[`verify-${e}`]=!1,0===t.this.getAttribute("type").split("-").length)return!1;for(let n=0;n<t.this.getAttribute("type").split("-").length;n++)t.this.getAttribute("type").split("-")[n]===e?t[`verify-${e}`]=!0:t[`verify-${e}`]=!1;return console.assert(!1,t),t[`verify-${e}`]}),i.tagName.toLowerCase()&&(n.component=i.tagName.toLowerCase()),"object"!=typeof i);else{if(i.getAttribute("type")){n.type=i.getAttribute("type").split("-");for(let t=0;t<n.type.length;t++)n.type[t]=n.type[t].replace(/:/g,"-");for(let t in n.type)switch(n.type[t]){case"swap":n["type-swap"]=!0;break;case"external":n["type-external"]=!0}}else n.type=["default"],i.setAttribute("type","default");if(i.slot?n.slot=i.slot:(i.slot=i.tagName.toLowerCase(),n.slot=i.slot),i.getAttribute("type")){let t=!1;for(let e in i.getAttribute("type").split("-"))-1!==i.getAttribute("type").split("-")[e].indexOf("style:")&&(t=!0);n["style-custom"]=!0===t?"not-default":"default"}}n.shadowRoot=!1,n.this=i,t(n)})).then(t=>{a(t).then(t=>{(function(t){return new Promise(function(e,n){let r=document.createElement("style"),a=document.createElement("style"),o={};(o=t.slot?t.slot:t.parent)||console.assert(!1,"не установленны ни слот ни парент");for(let e=0;e<t.type.length;e++)"swap"===t.type[e]?"scoped"===t.type[e]&&r.setAttribute("scoped",""):"scoped"===t.type[e]&&a.setAttribute("scoped","");for(let n=0;n<t.state.length;n++){switch(t[`path-style-${t.state[n]}`]=`@import '/static/html/components/${t.component}/${t.state[n]}/${t.component}.css'; @import '/static/html/components/${t.component}/${t.state[n]}/${t.component}-custom.css';`,t.state[n]){case"shadow":!0===t.verify.preset&&(t[`path-style-${t.state[n]}-preset`]=`@import '/static/html/components/${t.component}/template/${o}.css';`),r.innerText=t[`path-style-${t.state[n]}`]+t[`path-style-${t.state[n]}-preset`];break;case"light":!0===t.verify.preset&&(t[`path-style-${t.state[n]}-preset`]=`@import '/static/html/components/${t.component}/template/${o}.css';`),a.innerText=t[`path-style-${t.state[n]}`]+t[`path-style-${t.state[n]}-preset`]}"swap"===t.state[n]?!0===t.shadowRoot?(t.this.shadowRoot.appendChild(a),t.this.appendChild(r),e(t)):t.this.appendChild(r):!0===t.shadowRoot?(t.this.shadowRoot.appendChild(r),t.this.appendChild(a),e(t)):t.this.appendChild(a)}e(t)})})(t).then(t=>{!async function(t){bundle.default(t,null,async function(e,n){function r(t){let e=Math.floor(t/1e3),n=Math.floor(e/3600);e-=3600*n;let r=Math.floor(e/60);return e=("00"+(e=""+(e-=60*r))).substring(e.length),n>0?(r=("00"+(r=r<10?"0"+r:""+r)).substring(r.length),n+":"+r+":"+e):"00:"+(r=r<10?"0"+r:""+r)+":"+e}function a(t){return new Promise(async function(e,n){let a=setTimeout(async function n(){let o=await matcher.server({path:`/timer/${t.id}`,type:"timer"},"get","type");if(o.mongo.time<=0){t.data.innerText="завершён";let n=0;console.log(o.mongo);for(let t=0;t<o.mongo.auction.count.length;t++)o.mongo.auction.count[t]===o.mongo.auction.winner&&n++;let r=o.mongo.auction.winner,i=10*+o.mongo.auction.lotAmount,s=await matcher.server({path:"/winner",type:"winner",data:{auctionId:o.mongo.auction.auctionId,winner:r,endHeight:o.mongo.auction.endHeight,lotAmount:i,bid:n}},"set","type");await window.wt.nodeInteraction.waitForTx(s.mongo.id,{apiBase:"https://nodes-testnet.wavesnodes.com"});let l=await WavesKeeper.publicState(),c=await matcher.server({input:"waves-auth",path:`/winner/${l.account.address}`,type:"winner"},"get","type");if(c.mongo.length>0){let t=document.createElement("div");t.className="winner";for(let e=0;e<c.mongo.length;e++){let n=+c.mongo[e].winner.payment[0].amount/1e8+.014;n=n.toFixed(3);let r=`<div class="info">\n                                    <div> Лот: ${c.mongo[e].object}</div>\n                                    <div class="priceLot"> Стоимость лота: ${n} Waves</div>\n                                    <button class="pay ${c.mongo[e].object}">Оплатить</button>\n                              </div>`;t.insertAdjacentHTML("beforeend",r)}let e=await store({input:"varan-card-news",type:"all"},"get","type");e["waves-auth"][0].this.shadowRoot.querySelector("#winner").style.display="flex",e["waves-auth"][0].this.shadowRoot.querySelector("#winner").innerHTML="",e["waves-auth"][0].this.shadowRoot.querySelector("#winner").appendChild(t);let n=e["waves-auth"][0].this.shadowRoot.querySelectorAll(".pay");for(let t=0;t<n.length;t++)await addEventListener({input:"waves-auth",data:n[t],type:"payLot"},"set","type")}clearTimeout(a),e(t.data.innerText)}else{let e=o.mongo,i=+e.lotAmount;i=i.toFixed(1),t.info.name.innerText=`${e.winner}`,t.info.price.innerText=`Waves: ${i}`;let s=0;for(let t=0;t<e.count.length;t++)e.count[t]===e.winner&&s++;let l=+e.lotAmount,c=l+.014;c=c.toFixed(3),t.info.outPrice.innerText=`Waves: ${c}`,t.data.innerText=r(e.time),a=setTimeout(n,900)}},900)})}let o=!1;for(let e=0;e<t.this.slot.split("-").length;e++)"admin"===t.this.slot.split("-")[e]&&(o=!0);let i={};if(o){await store({input:"varan-card-news",this:t.this,img:t.this.shadowRoot.querySelector(".imgBidAdmin"),slot:t.slot,parent:t.this.getAttribute("parent"),type:"obj"},"set","type");let e=await action({input:"lacerta-card-news",type:"itemsBid",name:"itemsBid"},"get","type");if(n.isEmpty(e.mongo))console.warn("нет объектов");else{t.this.shadowRoot.querySelector(".section").innerHTML="";for(let n=0;n<e.mongo.length;n++){let r=await templateItem({input:"varan-cards-news-admin",data:e.mongo[n].item,type:"cardAdmin"},"get","type");t.this.shadowRoot.querySelector(".section").insertAdjacentHTML("beforeend",r);let a=t.this.shadowRoot.querySelector(`.timestamp_${Date.parse(e.mongo[n].item.date_modified)}`);a.querySelector(".change").addEventListener("click",async e=>{let n=e.target,r=!1;for(;!r;)"DIV"===n.tagName&&n.className.indexOf("item")>-1?r=!0:n=n.parentNode;let a={};a.timestamp=+n.className.split("_")[1],a.iso=new Date(a.timestamp).toISOString(),a.utc=new Date(a.timestamp).toUTCString();let o=await matcher.server({path:`/timer/${a.timestamp}`,type:"timer"},"get","type");-2===o.mongo.time?(n.querySelector(".change").innerText="данные добавляются",n.querySelector(".change").disabled=!0,staticProperty({type:"task",task:{button:n.querySelector(".change"),type:"update",date:a,this:t.this},name:"bid"},"task","type")):alert("Проходит аукцион, редактирование невозможно")}),a.querySelector(".delete").addEventListener("click",async t=>{let e=t.target,n=!1;for(;!n;)"DIV"===e.tagName&&e.className.indexOf("item")>-1?n=!0:e=e.parentNode;let r={};r.timestamp=+e.className.split("_")[1],r.iso=new Date(r.timestamp).toISOString(),r.utc=new Date(r.timestamp).toUTCString();let a=await matcher.server({path:`/timer/${r.timestamp}`,type:"timer"},"get","type");if(-2===a.mongo.time){let t=confirm("Вы точно хотите удалить новость ?");t&&(e.querySelector(".change").remove(),e.querySelector(".delete").innerText="Идёт процесс удаления",e.querySelector(".delete").style.backgroundColor="red",e.querySelector(".delete").disabled=!0,staticProperty({type:"task",task:{type:"delete",date:r,remove:e},name:"bid"},"task","type"))}else alert("Проходит аукцион, вы не можете удалить товар")})}}t.this.shadowRoot.querySelector("#image").onchange=function(e){let n=new CustomEvent("sideBarCrop",{detail:{id:t.component,slot:t.slot,file:e.target.files[0]}});document.dispatchEvent(n),e.target.value=""}}else{await store({input:"varan-card-news",this:t.this,img:t.this.shadowRoot.querySelector(".imgBidAdmin"),slot:t.slot,parent:t.this.getAttribute("parent"),type:"obj"},"set","type");let e={};if(e=await action({input:"lacerta-card-news",type:"itemsBid",name:"itemsBid"},"get","type"),n.isEmpty(e))console.warn("нет объектов");else{t.this.shadowRoot.querySelector(".section").innerHTML="";for(let n=0;n<e.mongo.length;n++){i=await templateItem({input:"bid_card",data:e.mongo[n].item,type:"card"},"get","type"),t.this.shadowRoot.querySelector(".section").insertAdjacentHTML("beforeend",i);let o=Date.parse(e.mongo[n].item.date_modified),s=t.this.shadowRoot.querySelector(`.timestamp_${o}`),l=await matcher.server({path:`/timer/${o}`,type:"timer"},"get","type");-2===l.mongo.time||(-1===l.mongo.time?console.assert(!1):(s.querySelector(".outPrice").innerText=`Waves: ${l.mongo.lotAmount}`,s.querySelector(".name").innerText=l.mongo.winer,s.querySelector(".sellButton").innerText="Аукцион",s.querySelector(".sellButton").disabled=!0,s.querySelector(".timer").innerText=r(l.mongo.time),s.classList.add("timer"),a({id:o,data:s.querySelector(".timer"),this:s,info:{name:s.querySelector(".name"),price:s.querySelector(".price"),outPrice:s.querySelector(".outPrice")}}).then(t=>{s.querySelector(".sellButton").innerText="Старт"}))),s.querySelector(".bidButton").addEventListener("click",async t=>{let e=t.target,n=!1;for(;!n;)"DIV"===e.tagName&&e.className.indexOf("item")>-1?n=!0:e=e.parentNode;e.querySelector(".bidButton").innerText="делается ставка",e.querySelector(".bidButton").disabled=!0;let r=await matcher.server({path:`/timer/${o}`,type:"timer"},"get","type");if(-2===r.mongo.time)alert("Аукцион ещё не начался"),e.querySelector(".bidButton").innerText="ставка",e.querySelector(".bidButton").disabled=!1;else if(-1===r.mongo.time)alert("Аукцион ещё не начался"),e.querySelector(".bidButton").innerText="ставка",e.querySelector(".bidButton").disabled=!1;else try{let t=await WavesKeeper.publicState();if(t.account.balance.available<1e8)alert("У вас недостаточно средств, что бы сделать ставку"),e.querySelector(".bidButton").innerText="ставка",e.querySelector(".bidButton").disabled=!1;else{let n=e.className.split("_")[1];n=+(n=n.split(" ")[0]);let r=await matcher.server({path:`/timer/${n}`,type:"timer"},"get","type"),a=0;for(let e=0;e<r.mongo.count.length;e++)r.mongo.count[e]===t.account.address&&a++;let o=1.014,i=+t.account.balance.available/1e8;if(i<o)alert("у вас не достаточно средств для ставки"),e.querySelector(".bidButton").innerText="ставка",e.querySelector(".bidButton").disabled=!1;else{let r=await matcher.server({path:`/checked/${n}`,type:"account",data:{account:t.account.address}},"checked","type");if(-3===r.mongo.update)alert("Вы уже сделали последнюю ставку"),e.querySelector(".bidButton").innerText="ставка",e.querySelector(".bidButton").disabled=!1;else{let a=0;for(let t=0;t<r.mongo.auction.count.length;t++)r.mongo.auction.count[t]===r.mongo.auction.winner&&a++;let o=parseInt(10*+r.mongo.auction.lotAmount,10),i=r.mongo.auction.auctionId,s=+r.mongo.auction.endHeight;try{let r={},l=await fetch(`https://nodes-testnet.wavesnodes.com/addresses/scriptInfo/${t.account.address}`);l=(l=await l.json()).extraFee/1e8+.005,l=parseFloat(l.toFixed(4),10),r={type:16,data:{fee:{tokens:`${l}`,assetId:"WAVES"},dApp:window.wt.dappaddress,call:{function:"bid",args:[{type:"string",value:i},{type:"integer",value:a},{type:"integer",value:o},{type:"integer",value:s}]},payment:[{amount:1e8,assetId:null}]}},e.querySelector(".bidButton").innerText="завершение процесса";let c=await WavesKeeper.signAndPublishTransaction(r),p=await matcher.server({path:`/timer/${n}`,type:"account",data:{account:t.account.address}},"update","type");c=JSON.parse(c),await window.wt.nodeInteraction.waitForTx(c.id,{apiBase:"https://nodes-testnet.wavesnodes.com"}),e.querySelector(".name").innerText=`${p.mongo.data.auction.winner}`,e.querySelector(".price").innerText=`Waves: ${p.mongo.data.auction.lotAmount.toFixed(1)}`;let d=p.mongo.data.auction.lotAmount+.05;d=d.toFixed(3),e.querySelector(".outPrice").innerText=`Waves: ${d}`,e.querySelector(".bidButton").innerText="ставка",e.querySelector(".bidButton").disabled=!1}catch(t){console.warn("ошибка",t)}}}}}catch(t){alert("У вас не установлен Waves Keepper, работа без него в процессе разработки"),e.querySelector(".bidButton").innerText="ставка",e.querySelector(".bidButton").disabled=!1}}),s.querySelector(".sellButton").addEventListener("click",async t=>{let e=t.target,n=!1;for(;!n;)"DIV"===e.tagName&&e.className.indexOf("item")>-1?n=!0:e=e.parentNode;let i=+e.className.split("_")[1];try{let t=await WavesKeeper.publicState(),n=e.querySelector(".timer").innerText;n=n.split(":"),n=(n=60*parseInt(n[0],10)+parseInt(n[1],10)).toString();let s=await matcher.server({path:`/timer/${o}`,type:"timer"},"get","type");if(-2===s.mongo.time)if("завершён"===n.toLowerCase())alert("Аукцион прошёл, войдите в панель администратора, что создать новый");else{n=+n,n*=6e4;let o=t.account.balance.available/1e8;if(o<1.05)alert("У вас недостаточно средств для создания аукциона");else{e.querySelector(".sellButton").innerText="Создаётся аукцион",e.querySelector(".sellButton").disabled=!0;try{let o=await matcher.server({input:"caran-card-news",type:"nft",data:{id:`${i}`,dApp:window.wt.dappaddress},path:"/nft"},"get","type");await window.wt.nodeInteraction.waitForTx(o.mongo.id,{apiBase:"https://nodes-testnet.wavesnodes.com"});let s=e.querySelector(".price").innerText;s=parseInt(s.split(":")[1],10);let l={};l.organizer=t.account.address,l.lotAssetId="WAVES",l.lotAmount=s,l.startPrice=s,l.priceAssetId="WAVES",l.winner=t.account.address,l.winAmount=s,l.startHeight=o.mongo.timestamp,l.startTime=n,l.endHeight=o.mongo.timestamp+n,l.count=[],l.count.push(t.account.address),l.count=JSON.stringify(l.count),l.name=i;let c=await fetch(`https://nodes-testnet.wavesnodes.com/addresses/scriptInfo/${t.account.address}`);c=(c=await c.json()).extraFee/1e8+.005,c=parseFloat(c.toFixed(4),10);try{let n={type:16,data:{fee:{tokens:`${c}`,assetId:"WAVES"},dApp:window.wt.dappaddress,call:{function:"startAuction",args:[{type:"integer",value:l.endHeight},{type:"integer",value:l.startPrice},{type:"string",value:o.mongo.id},{type:"string",value:"WAVES"}]},payment:[{amount:1e8,assetId:null}]}};try{let i=await WavesKeeper.signAndPublishTransaction(n);i=JSON.parse(i),await window.wt.nodeInteraction.waitForTx(i.id,{apiBase:"https://nodes-testnet.wavesnodes.com"}),l.auctionId=o.mongo.id;let s=await matcher.server({path:"/auction",type:"auction",data:l},"set","type"),c=parseInt(l.lotAmount,10)+.005,p=parseInt(s.mongo.data.auction.endHeight,10)-Date.now();e.querySelector(".outPrice").innerText=`Waves: ${c}`,e.querySelector(".name").innerText=t.account.address,e.querySelector(".sellButton").innerText="Аукцион",e.querySelector(".timer").innerText=r(p),e.classList.add("timer"),a({id:l.name,data:e.querySelector(".timer"),this:e,info:{name:e.querySelector(".name"),price:e.querySelector(".price"),outPrice:e.querySelector(".outPrice")}}).then(t=>{e.querySelector(".sellButton").innerText="Старт"})}catch(t){console.warn(t),e.querySelector(".sellButton").innerText="Старт",e.querySelector(".sellButton").disabled=!1}}catch(t){console.warn(t),e.querySelector(".sellButton").innerText="Старт",e.querySelector(".sellButton").disabled=!1}}catch(t){console.warn(t),e.querySelector(".sellButton").innerText="Старт",e.querySelector(".sellButton").disabled=!1}}}else alert("Аукцион уже проходит")}catch(t){alert("У вас не установлен Waves Keepper, работа без него в процессе разработки")}})}!async function(){let e=setTimeout(async function n(){let o=await matcher.server({path:"/auction",type:"auctions"},"get","type"),i=t.this.shadowRoot.querySelectorAll(".item");for(let t=0;t<i.length;t++)if(i[t].className.indexOf("timer")>-1);else for(let e=0;e<o.mongo.length;e++)parseInt(o.mongo[e].object,10)===parseInt(i[t].className.split("_")[1],10)&&(i[t].querySelector(".outPrice").innerText=`Waves: ${o.mongo[e].auction.lotAmount}`,i[t].querySelector(".name").innerText=o.mongo[e].auction.winer,i[t].querySelector(".sellButton").innerText="Аукцион",i[t].querySelector(".sellButton").disabled=!0,i[t].querySelector(".timer").innerText=r(parseInt(o.mongo[e].auction.endHeight,10)-Date.now()),i[t].classList.add("timer"),a({id:o.mongo[e].object,data:i[t].querySelector(".timer"),this:i[t],info:{name:i[t].querySelector(".name"),price:i[t].querySelector(".price"),outPrice:i[t].querySelector(".outPrice")}}).then(e=>{i[t].querySelector(".sellButton").innerText="Старт"}));e=setTimeout(n,1e3)},1e3)}()}}})}(t)})})})}});