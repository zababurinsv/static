!function(e){var t=!1,n=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/,i=function(){};i.extend=function(e){var r=this.prototype;t=!0;var o=new this;for(var s in t=!1,e)o[s]="function"==typeof e[s]&&"function"==typeof r[s]&&n.test(e[s])?function(e,t){return function(){var n=this._super;this._super=r[e];var i=t.apply(this,arguments);return this._super=n,i}}(s,e[s]):e[s];function a(){!t&&this.init&&this.init.apply(this,arguments)}return a.prototype=o,a.prototype.constructor=a,a.extend=i.extend,a};var r={debug:!1,trace:function(t){this.debug&&void 0!==e.console&&e.console.log("Porthole: "+t)},error:function(t){void 0!==typeof e.console&&"function"==typeof e.console.error&&e.console.error("Porthole: "+t)},WindowProxy:function(){}};r.WindowProxy.prototype={post:function(e,t){},addEventListener:function(e){},removeEventListener:function(e){}},r.WindowProxyBase=i.extend({init:function(t){void 0===t&&(t=""),this.targetWindowName=t,this.origin=e.location.protocol+"//"+e.location.host,this.eventListeners=[]},getTargetWindowName:function(){return this.targetWindowName},getOrigin:function(){return this.origin},getTargetWindow:function(){return r.WindowProxy.getTargetWindow(this.targetWindowName)},post:function(t,n){void 0===n&&(n="*"),this.dispatchMessage({data:t,sourceOrigin:this.getOrigin(),targetOrigin:n,sourceWindowName:e.name,targetWindowName:this.getTargetWindowName()})},addEventListener:function(e){return this.eventListeners.push(e),e},removeEventListener:function(e){var t;try{t=this.eventListeners.indexOf(e),this.eventListeners.splice(t,1)}catch(e){this.eventListeners=[]}},dispatchEvent:function(e){var t;for(t=0;t<this.eventListeners.length;t++)try{this.eventListeners[t](e)}catch(e){r.error(e)}}}),r.WindowProxyLegacy=r.WindowProxyBase.extend({init:function(e,t){this._super(t),null!==e?(this.proxyIFrameName=this.targetWindowName+"ProxyIFrame",this.proxyIFrameLocation=e,this.proxyIFrameElement=this.createIFrameProxy()):(this.proxyIFrameElement=null,r.trace("proxyIFrameUrl is null, window will be a receiver only"),this.post=function(){throw new Error("Receiver only window")})},createIFrameProxy:function(){var e=document.createElement("iframe");return e.setAttribute("id",this.proxyIFrameName),e.setAttribute("name",this.proxyIFrameName),e.setAttribute("src",this.proxyIFrameLocation),e.setAttribute("frameBorder","1"),e.setAttribute("scrolling","auto"),e.setAttribute("width",30),e.setAttribute("height",30),e.setAttribute("style","position: absolute; left: -100px; top:0px;"),e.style.setAttribute&&e.style.setAttribute("cssText","position: absolute; left: -100px; top:0px;"),document.body.appendChild(e),e},dispatchMessage:function(t){var n=e.encodeURIComponent;if(this.proxyIFrameElement){var i=this.proxyIFrameLocation+"#"+n(r.WindowProxy.serialize(t));this.proxyIFrameElement.setAttribute("src",i),this.proxyIFrameElement.height=this.proxyIFrameElement.height>50?50:100}}}),r.WindowProxyHTML5=r.WindowProxyBase.extend({init:function(e,t){this._super(t),this.eventListenerCallback=null},dispatchMessage:function(e){this.getTargetWindow().postMessage(r.WindowProxy.serialize(e),e.targetOrigin)},addEventListener:function(t){if(0===this.eventListeners.length){var n=this;e.addEventListener?(this.eventListenerCallback=function(e){n.eventListener(n,e)},e.addEventListener("message",this.eventListenerCallback,!1)):e.attachEvent&&(this.eventListenerCallback=function(t){n.eventListener(n,e.event)},e.attachEvent("onmessage",this.eventListenerCallback))}return this._super(t)},removeEventListener:function(t){this._super(t),0===this.eventListeners.length&&(e.removeEventListener?e.removeEventListener("message",this.eventListenerCallback):e.detachEvent&&(void 0===e.onmessage&&(e.onmessage=null),e.detachEvent("onmessage",this.eventListenerCallback)),this.eventListenerCallback=null)},eventListener:function(e,t){var n=r.WindowProxy.unserialize(t.data);!n||""!==e.targetWindowName&&n.sourceWindowName!=e.targetWindowName||e.dispatchEvent(new r.MessageEvent(n.data,t.origin,e))}}),e.postMessage?(r.trace("Using built-in browser support"),r.WindowProxy=r.WindowProxyHTML5.extend({})):(r.trace("Using legacy browser support"),r.WindowProxy=r.WindowProxyLegacy.extend({})),r.WindowProxy.serialize=function(e){if("undefined"==typeof JSON)throw new Error("Porthole serialization depends on JSON!");return JSON.stringify(e)},r.WindowProxy.unserialize=function(e){if("undefined"==typeof JSON)throw new Error("Porthole unserialization dependens on JSON!");try{var t=JSON.parse(e)}catch(e){return!1}return t},r.WindowProxy.getTargetWindow=function(t){return""===t?parent:"top"===t||"parent"===t?e[t]:e.frames[t]},r.MessageEvent=function(e,t,n){this.data=e,this.origin=t,this.source=n},r.WindowProxyDispatcher={forwardMessageEvent:function(t){var n,i,o,s=e.decodeURIComponent;document.location.hash.length>0&&(n=r.WindowProxy.unserialize(s(document.location.hash.substr(1))),i=r.WindowProxy.getTargetWindow(n.targetWindowName),(o=r.WindowProxyDispatcher.findWindowProxyObjectInWindow(i,n.sourceWindowName))?o.origin===n.targetOrigin||"*"===n.targetOrigin?o.dispatchEvent(new r.MessageEvent(n.data,n.sourceOrigin,o)):r.error("Target origin "+o.origin+" does not match desired target of "+n.targetOrigin):r.error("Could not find window proxy object on the target window"))},findWindowProxyObjectInWindow:function(e,t){var n;if(e)for(n in e)if(Object.prototype.hasOwnProperty.call(e,n))try{if(null!==e[n]&&"object"==typeof e[n]&&e[n]instanceof e.Porthole.WindowProxy&&e[n].getTargetWindowName()===t)return e[n]}catch(e){}return null},start:function(){e.addEventListener?e.addEventListener("resize",r.WindowProxyDispatcher.forwardMessageEvent,!1):e.attachEvent&&"undefined"!==e.postMessage?e.attachEvent("onresize",r.WindowProxyDispatcher.forwardMessageEvent):document.body.attachEvent?e.attachEvent("onresize",r.WindowProxyDispatcher.forwardMessageEvent):r.error("Cannot attach resize event")}},"undefined"!=typeof exports?module.exports=r:e.Porthole=r}("undefined"!=typeof window?window:this);